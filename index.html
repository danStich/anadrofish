<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Anadromous Fish Population Responses to Habitat Changes • anadrofish</title>
<script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="Anadromous Fish Population Responses to Habitat Changes">
<meta name="description" content="Stochastic estimation of anadromous fish population response to changes in habitat.">
<meta property="og:description" content="Stochastic estimation of anadromous fish population response to changes in habitat.">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">anadrofish</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.3.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-home">
<div class="row">
  <main id="main" class="col-md-9"><div class="section level1">
<div class="page-header"><h1 id="anadrofish">anadrofish<a class="anchor" aria-label="anchor" href="#anadrofish"></a>
</h1></div>
<p>R package for modeling anadromous fish population responses to habitat changes</p>
<p><a href="https://doi.org/10.5281/zenodo.14285894" class="external-link"><img src="https://zenodo.org/badge/186272264.svg" alt="DOI"></a> <a href="https://www.gnu.org/licenses/gpl-3.0" class="external-link"><img src="https://img.shields.io/badge/License-GPLv3-blue.svg" alt="License: GPL v3"></a> <a href="https://github.com/danStich/anadrofish/actions/workflows/R-CMD-check.yaml" class="external-link"><img src="https://github.com/danStich/anadrofish/actions/workflows/R-CMD-check.yaml/badge.svg" alt="R-CMD-check"></a> <a href="https://github.com/danStich/anadrofish/actions/workflows/test-coverage.yaml" class="external-link"><img src="https://github.com/danStich/anadrofish/actions/workflows/test-coverage.yaml/badge.svg" alt="test-coverage.yaml"></a></p>
<div class="section level2">
<h2 id="table-of-contents">Table of Contents<a class="anchor" aria-label="anchor" href="#table-of-contents"></a>
</h2>
<ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#installation">Installation</a></li>
<li><a href="#directories">Directories</a></li>
<li><a href="#examples">Examples</a></li>
<li><a href="#references">References</a></li>
</ul>
</div>
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<div class="section level3">
<h3 id="purpose">Purpose<a class="anchor" aria-label="anchor" href="#purpose"></a>
</h3>
<p>The purpose of this package is to distribute code and provide a user interface for modeling anadromous fish population responses to dam passage, fisheries, or restoration activities in Atlantic coastal rivers of Canada and the United States. The main <code><a href="reference/sim_pop.html">sim_pop()</a></code> function uses various helper functions (see <code><a href="reference/anadrofish-package.html">?anadrofish</a></code> in R) that link dam passage to habitat availability and stochastic population models to simulate species-specific responses to dams and fisheries across marine and freshwater habitats (Figure 1 below). Built-in habitat datasets are currently derived separately for each species based on best available knowledge and expert opinion from state and federal fishery biologists, managers, and scientists. Likewise, all species-specific life-history parameters (size at age, age at maturity, natural mortality) are derived directly from interstate stock assessments or informed by empirical estimates from the fisheries literature. The application of these models is described in <a href="https://asmfc.org/uploads/file/63d8437dAmShadBenchmarkStockAssessment_PeerReviewReport_2020_web.pdf" class="external-link">ASMFC (2020)</a>, <a href="https://www.frontiersin.org/journals/marine-science/articles/10.3389/fmars.2021.734213/full" class="external-link">Zydlewski et al. (2021)</a>, and <a href="https://asmfc.org/uploads/file/66f59e40RiverHerringAssessment_PeerReviewReport_2024.pdf" class="external-link">ASMFC (2024)</a>.</p>
<figure><img src="reference/figures/conceptual-model.jpg?raw=true" alt="Graphical overview of the anadrofish workflow (right) compared to conceptual life-history model for anadromous fishes (left). Helper functions are used within the sim_pop() function along with built-in data sets to simulate anadromous fish populations."><figcaption><b>Figure 1</b>: Graphical overview of the <code>anadrofish</code> workflow (right) compared to conceptual life-history model for anadromous fishes (left). Helper functions are used within the <code><a href="reference/sim_pop.html">sim_pop()</a></code> function along with built-in data sets to simulate anadromous fish populations.
</figcaption></figure><p> </p>
<p>Existing (built-in) population models for each species can be implemented using the <code><a href="reference/sim_pop.html">sim_pop()</a></code> function. New models can be constructed using the existing helper functions within <code>anadrofish</code> and appropriately structured habitat data. <strong>As of version 2.1.0</strong> (2024-11-26), we implemented the <code><a href="reference/custom_habitat_template.html">custom_habitat_template()</a></code> function. This allows use of default habitat data sets, modifying habitat data based on built-in datasets, querying custom habitat datasets ranging from the single stream segment to regional stock scales for each species, or constructing completely custom habitat configurations including fabricated (i.e., theoretical) habitat configurations for optimization studies.</p>
</div>
<div class="section level3">
<h3 id="species">Species<a class="anchor" aria-label="anchor" href="#species"></a>
</h3>
<p>These models are available for 167 American shad (<em>Alosa sapidissima</em>) populations, 222 alewife (<em>Alosa pseudoharengus</em>) populations, and 238 blueback herring (<em>Alosa aestivalis</em>) populations in Atlantic Coastal rivers of North America from Florida, USA (St. Johns River) to Quebec, Canada (St. Lawrence drainage). American shad models and data were peer-reviewed during the <a href="https://asmfc.org/wp-content/uploads/2025/01/AmShadBenchmarkStockAssessment_PeerReviewReport_2020_web.pdf" class="external-link">2020 Atlantic States Marine Fisheries Commission (ASMFC) American Shad Benchmark Stock Assessment</a>. River herring models and underlying data were peer-reviewed during development and application to the <a href="https://asmfc.org/uploads/file/66f59e40RiverHerringAssessment_PeerReviewReport_2024.pdf" class="external-link">2024 ASMFC River Herring Benchmark Stock Assessment</a>.</p>
<p>The full list of rivers available for each species can be viewed with <code><a href="reference/get_rivers.html">get_rivers()</a></code> once the package is installed.</p>
<p>We are currently working with collaborators to extend to multiple additional species. Please feel free to contact us with requests, post an issue, or see <a href="https://github.com/danStich/anadrofish/blob/master/Contributing.md" class="external-link">Contributing.md</a> for details about other ways to contribute!</p>
<p></p>
</div>
</div>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<div class="section level3">
<h3 id="versions-230-and-later">Versions 2.3.0 and later<a class="anchor" aria-label="anchor" href="#versions-230-and-later"></a>
</h3>
<p>As of version 2.3.0 the <code>anadrofish</code> package no longer requires compilation and can therefore be installed using the <code>remotes</code> package (Csardi et al. 2021) in R. Once you have installed the <code>remotes</code> package, <code>anadrofish</code> can be installed like this:</p>
<p><code>remotes::install_github("danStich/anadrofish")</code></p>
<p>Specific releases can be installed by referencing the release tag, like this:</p>
<p><code>remotes::install_github("danStich/anadrofish@v2.3.0")</code></p>
<p>The <code>remotes</code> package can be installed directly from CRAN or from GitHub following instructions in the repository <a href="https://github.com/r-lib/remotes#readme" class="external-link">https://github.com/r-lib/remotes#readme</a>.</p>
</div>
<div class="section level3">
<h3 id="versions-220-and-earlier">Versions 2.20 and earlier<a class="anchor" aria-label="anchor" href="#versions-220-and-earlier"></a>
</h3>
<p>Earlier versions of this package can be installed with the <a href="https://www.rstudio.com/products/rpackages/devtools/" class="external-link"><code>devtools</code></a> package (Wickam et al. 2022) in R using the repository url:</p>
<p><code>devtools::install_github("danStich/anadrofish")</code></p>
<p>Specific releases can be installed by referencing the release tag, like this:</p>
<p><code>devtools::install_github("danStich/anadrofish@v2.1.0")</code></p>
<p>To install <code>anadrofish</code>, you will need to have <code>devtools</code> installed ahead of time in R, but that requires some special tools. To install on <strong>Windows</strong>, you will need to download and install the appropriate version of <a href="https://cran.r-project.org/bin/windows/Rtools/" class="external-link">Rtools</a>. To install on <strong>Mac</strong>, you will need to have the <a href="http://osxdaily.com/2014/02/12/install-command-line-tools-mac-os-x/" class="external-link">XCode command-line tools</a> installed. And, if running from <strong>Linux</strong>, you will need to install the developer version of R (<code>r-base-dev</code>) if you have not already. You may need to work with your IT specialists or someone with administrative privileges if you do not have them to install these utilities.</p>
<p></p>
</div>
</div>
<div class="section level2">
<h2 id="examples">Examples<a class="anchor" aria-label="anchor" href="#examples"></a>
</h2>
<div class="section level3">
<h3 id="running-one-scenario-for-one-river-many-times-in-parallel">Running one scenario for one river many times in parallel<a class="anchor" aria-label="anchor" href="#running-one-scenario-for-one-river-many-times-in-parallel"></a>
</h3>
<p>This example uses alewife in the Sebasticook River, ME, USA <a href="https://onlinelibrary.wiley.com/doi/full/10.1002/tafs.10292" class="external-link">Wipplehauser 2021</a> to understand baseline population predictions following the removal of Edwards Dam in 1999, removal of Fort Halifax Dam in 2008, and installation of a fish lift at the next dam in the Sebasticook River. Approximately 1-6 million spawning alewife have passed upstream of Benton Falls (5.3 miles from mouth of Sebasticook River, and 17 miles from Edwards Dam) annually since then.</p>
<p>In this example, we return output from <code><a href="reference/sim_pop.html">sim_pop()</a></code> using <code>years = "all"</code> to also demonstrate the number of years needed for a stable population estimate under this scenario. If we wanted to model changes over time, we would run different scenarios for each year and return only the final year of simulations using <code>years = "last"</code>. In theory, this approach could also be used to identify stable population sizes for seeding the initial population in temporal studies, but this has not been validated.</p>
<p>The data set is in the <code>inst/data</code> folder on the GitHub repo but is ignored during R package install.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Package load ----</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">snowfall</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://danstich.github.io/anadrofish/">anadrofish</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set a seed for random number generators for reproducibility ----</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">12345</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Parallel settings ----</span></span>
<span><span class="co"># Get number of cores for simulation using parallel package</span></span>
<span><span class="va">ncpus</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html" class="external-link">detectCores</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span></span>
<span></span>
<span><span class="co"># Initialize snowfall socket cluster</span></span>
<span><span class="fu">sfInit</span><span class="op">(</span>parallel <span class="op">=</span> <span class="cn">TRUE</span>, cpus <span class="op">=</span> <span class="va">ncpus</span>, type <span class="op">=</span> <span class="st">"SOCK"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Read in the Sebasticook River data ----</span></span>
<span><span class="co"># This data set is in the inst/data folder on the GitHub repo</span></span>
<span><span class="va">sebasticook_habitat_data</span> <span class="op">&lt;-</span> <span class="fu">read_csv</span><span class="op">(</span><span class="st">"https://raw.githubusercontent.com/danStich/anadrofish/refs/heads/master/inst/data/sebasticook_habitat.csv"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sebasticook_habitat_data</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    Latitude <span class="op">=</span> <span class="va">sebasticook_habitat_data</span><span class="op">$</span><span class="va">Latitude</span>,</span>
<span>    DamOrder <span class="op">=</span> <span class="va">sebasticook_habitat_data</span><span class="op">$</span><span class="va">DamOrder</span>,</span>
<span>    Hab_sqkm <span class="op">=</span> <span class="va">sebasticook_habitat_data</span><span class="op">$</span><span class="va">Hab_sqkm</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Make a custom habitat data set for the Sebasticook River, ME</span></span>
<span><span class="co"># since it is only included as part of the larger Kennebec River</span></span>
<span><span class="co"># watershed for river herring</span></span>
<span><span class="va">sebasticook_habitat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  river <span class="op">=</span> <span class="st">"Sebasticook"</span>,</span>
<span>  region <span class="op">=</span> <span class="st">"NNE"</span>,</span>
<span>  govt <span class="op">=</span> <span class="st">"ME"</span>,</span>
<span>  lat <span class="op">=</span> <span class="va">sebasticook_habitat_data</span><span class="op">$</span><span class="va">Latitude</span>,</span>
<span>  lon <span class="op">=</span> <span class="op">-</span><span class="fl">69.4139</span>,</span>
<span>  dam_name <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>  dam_order <span class="op">=</span> <span class="va">sebasticook_habitat_data</span><span class="op">$</span><span class="va">DamOrder</span>,</span>
<span>  Hab_sqkm <span class="op">=</span> <span class="va">sebasticook_habitat_data</span><span class="op">$</span><span class="va">Hab_sqkm</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Wrapper function ----</span></span>
<span><span class="va">sim</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># . Call simulation ----</span></span>
<span>  <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/sim_pop.html">sim_pop</a></span><span class="op">(</span></span>
<span>    species <span class="op">=</span> <span class="st">"ALE"</span>,</span>
<span>    river <span class="op">=</span> <span class="st">"Sebasticook"</span>,</span>
<span>    nyears <span class="op">=</span> <span class="fl">50</span>,</span>
<span>    n_init <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1e6</span>, <span class="fl">22e7</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    sr <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>    b <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>    upstream <span class="op">=</span> <span class="fl">1</span>, <span class="co"># runif(1, 0.95, 1.00), # Could draw from a uniform instead</span></span>
<span>    downstream <span class="op">=</span> <span class="fl">1</span>, <span class="co"># runif(1, 0.95, 1.00),</span></span>
<span>    downstream_j <span class="op">=</span> <span class="fl">1</span>, <span class="co"># runif(1, 0.95, 1.00),</span></span>
<span>    output_years <span class="op">=</span> <span class="st">"all"</span>,</span>
<span>    age_structured_output <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    sex_specific <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    custom_habitat <span class="op">=</span> <span class="va">sebasticook_habitat</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># . Define the output lists ----</span></span>
<span>  <span class="va">retlist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    res <span class="op">=</span> <span class="va">res</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">retlist</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span></span>
<span><span class="co"># Parallel execution ----</span></span>
<span><span class="co"># . Load libraries on workers -----</span></span>
<span><span class="fu">sfLibrary</span><span class="op">(</span><span class="va">anadrofish</span><span class="op">)</span></span>
<span><span class="fu">sfLibrary</span><span class="op">(</span><span class="va">tidyverse</span><span class="op">)</span></span>
<span><span class="fu">sfExport</span><span class="op">(</span><span class="st">"sebasticook_habitat"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># . Distribute to workers -----</span></span>
<span><span class="co"># Number of simulations to run</span></span>
<span><span class="va">niterations</span> <span class="op">&lt;-</span> <span class="fl">1e2</span></span>
<span></span>
<span><span class="co"># Run the simulation ----</span></span>
<span><span class="co"># Assign starting time</span></span>
<span><span class="va">start</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run the sim</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">sfLapply</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">niterations</span>, <span class="va">sim</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calculate and print run time</span></span>
<span><span class="va">total_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="va">start</span></span>
<span><span class="va">total_time</span></span>
<span></span>
<span><span class="co"># . Stop snowfall ----</span></span>
<span><span class="fu">sfStop</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Results ----</span></span>
<span><span class="co"># 'result' is a list of lists.</span></span>
<span></span>
<span><span class="co"># Extract results dataframes by string and rbind them</span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">result</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"res"</span><span class="op">)</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">resdf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu">rbindlist</span><span class="op">(</span><span class="va">res</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># . Summary statistics by passage scenario -----</span></span>
<span><span class="co"># Summary results by year to investigate number of years</span></span>
<span><span class="co"># needed for simulated population to stabilize given user inputs</span></span>
<span><span class="va">plotter</span> <span class="op">&lt;-</span> <span class="va">resdf</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">year</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span></span>
<span>    pop <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">spawners</span><span class="op">)</span>,</span>
<span>    lci <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">spawners</span>, <span class="fl">0.025</span><span class="op">)</span>,</span>
<span>    uci <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">spawners</span>, <span class="fl">0.975</span><span class="op">)</span>,</span>
<span>    samp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">spawners</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># . Plot the result ----</span></span>
<span><span class="co"># It looks like we need to run this model for at least 25 years or so</span></span>
<span><span class="co"># to get stable results for a given scenario</span></span>
<span><span class="va">seb_plot</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">plotter</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">year</span>, y <span class="op">=</span> <span class="va">pop</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span>linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_ribbon</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xmax <span class="op">=</span> <span class="va">year</span>, ymin <span class="op">=</span> <span class="va">lci</span>, ymax <span class="op">=</span> <span class="va">uci</span>, color <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span>, </span>
<span>  alpha <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span></span>
<span></span>
<span><span class="va">seb_plot</span></span></code></pre></div>
<figure><img src="reference/figures/seb_ale.jpg?raw=true" alt="Example result from Sebasticook River simulation"><figcaption><b>Figure 2</b>: Example result from Sebasticook River simulation.
</figcaption></figure><p> </p>
</div>
<div class="section level3">
<h3 id="running-multiple-scenarios-for-one-river-many-times-in-parallel">Running multiple scenarios for one river many times in parallel<a class="anchor" aria-label="anchor" href="#running-multiple-scenarios-for-one-river-many-times-in-parallel"></a>
</h3>
<p>This example uses American shad in the Connecticut River, CT, USA. Here, we benchmark model predictions against population estimates from the river prior to implementation of fish passage at Holyoke Dam, the most downstream dam in this river. Spawner abundance estimates for the population were on the order of about 400,000 to &gt; 1 million American shad prior to initial improvement of upstream passage at Holyoke Dam in 1974 and later, further improvements. Because we don’t “know” what downstream survival rates were through Holyoke Dam prior to 1974, we can consider multiple scenarios for adult and juvenile downstream survival through dams to gauge a range of potential conditions.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Package load ----</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">snowfall</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://danstich.github.io/anadrofish/">anadrofish</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set a seed for random number generators for reproducibility ----</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">12345</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Parallel settings ----</span></span>
<span><span class="co"># Get number of cores for simulation using parallel package</span></span>
<span><span class="va">ncpus</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html" class="external-link">detectCores</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span></span>
<span></span>
<span><span class="co"># Initialize snowfall socket cluster</span></span>
<span><span class="fu">sfInit</span><span class="op">(</span>parallel <span class="op">=</span> <span class="cn">TRUE</span>, cpus <span class="op">=</span> <span class="va">ncpus</span>, type <span class="op">=</span> <span class="st">"SOCK"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Wrapper function ----</span></span>
<span><span class="va">sim</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Define habitat</span></span>
<span>  <span class="co"># Extract the built-in habitat data for American shad in the Connecticut</span></span>
<span>  <span class="co"># River so we can use it to specify dam-specific passage rates</span></span>
<span>  <span class="va">ct_habitat</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/custom_habitat_template.html">custom_habitat_template</a></span><span class="op">(</span>species <span class="op">=</span> <span class="st">"AMS"</span>, </span>
<span>                                        built_in <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>                                        river <span class="op">=</span> <span class="st">"Connecticut"</span></span>
<span>                                        <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Make upstream passage at all dams zero, then add low passage rates</span></span>
<span>  <span class="co"># at Holyoke dam prior to fish passage improvements after 1974</span></span>
<span>  <span class="co"># (Table 2 in https://www.nrc.gov/docs/ML0701/ML070190410.pdf). This should</span></span>
<span>  <span class="co"># give us a nice check for whether simulated abundances are reasonable</span></span>
<span>  <span class="va">ct_passage</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">ct_habitat</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">holyoke_historical</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3.0</span>, <span class="fl">2.6</span>, <span class="fl">2.7</span>, <span class="fl">3.8</span>, <span class="fl">5.2</span>, <span class="fl">4.5</span>, <span class="fl">5.5</span>, <span class="fl">5.9</span>, <span class="fl">5.8</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">ct_passage</span><span class="op">[</span><span class="fl">9</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">holyoke_historical</span></span>
<span></span>
<span>  <span class="co"># We don't actually "know" what downstream survival rates were at Holyoke</span></span>
<span>  <span class="co"># at that time...unless we can dig up a study on it</span></span>
<span>  <span class="va">downstream</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">.1</span><span class="op">)</span>, <span class="fl">1</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">downstream_j</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">.1</span><span class="op">)</span>, <span class="fl">1</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Include estimates of commercial and sport fishery exploitation rates</span></span>
<span>  <span class="co"># from same document (Table 1 in https://www.nrc.gov/docs/ML0701/ML070190410.pdf)</span></span>
<span>  <span class="va">ct_exploitation</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">28.7</span>, <span class="fl">19.8</span>, <span class="fl">13.0</span>, <span class="fl">9.4</span>, <span class="fl">10.0</span>, <span class="fl">10.4</span>, <span class="fl">19.3</span>, <span class="fl">25.2</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fl">100</span></span>
<span>    </span>
<span>  <span class="co"># Need to convert this to an instantaneous rate for the model</span></span>
<span>  <span class="va">ct_f</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">ct_exploitation</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Choose a species</span></span>
<span>  <span class="va">species</span> <span class="op">&lt;-</span> <span class="st">"AMS"</span></span>
<span></span>
<span>  <span class="co"># . Call simulation ----</span></span>
<span>  <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/sim_pop.html">sim_pop</a></span><span class="op">(</span></span>
<span>    species <span class="op">=</span> <span class="va">species</span>,</span>
<span>    river <span class="op">=</span> <span class="st">"Connecticut"</span>,</span>
<span>    nyears <span class="op">=</span> <span class="fl">50</span>,</span>
<span>    n_init <span class="op">=</span> <span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/rnegbin.html" class="external-link">rnegbin</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1e6</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>    sr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html" class="external-link">rbeta</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">100</span>, <span class="fl">100</span><span class="op">)</span>,</span>
<span>    b <span class="op">=</span> <span class="fl">0.21904</span>,</span>
<span>    fM <span class="op">=</span> <span class="va">ct_f</span>,</span>
<span>    upstream <span class="op">=</span> <span class="va">ct_passage</span>,</span>
<span>    downstream <span class="op">=</span> <span class="va">downstream</span>,</span>
<span>    downstream_j <span class="op">=</span> <span class="va">downstream_j</span>,</span>
<span>    output_years <span class="op">=</span> <span class="st">"last"</span>,</span>
<span>    age_structured_output <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    sex_specific <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># . Define the output lists ----</span></span>
<span>  <span class="va">retlist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    res <span class="op">=</span> <span class="va">res</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">retlist</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span></span>
<span><span class="co"># Parallel execution ----</span></span>
<span><span class="co"># . Load libraries on workers -----</span></span>
<span><span class="fu">sfLibrary</span><span class="op">(</span><span class="va">anadrofish</span><span class="op">)</span></span>
<span><span class="fu">sfLibrary</span><span class="op">(</span><span class="va">tidyverse</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># . Distribute to workers -----</span></span>
<span><span class="co"># Number of simulations to run</span></span>
<span><span class="va">niterations</span> <span class="op">&lt;-</span> <span class="fl">1e4</span></span>
<span></span>
<span><span class="co"># Run the simulation ----</span></span>
<span><span class="co"># Assign starting time</span></span>
<span><span class="va">start</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run the sim</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">sfLapply</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">niterations</span>, <span class="va">sim</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calculate and print run time</span></span>
<span><span class="va">total_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="va">start</span></span>
<span><span class="va">total_time</span></span>
<span></span>
<span><span class="co"># . Stop snowfall ----</span></span>
<span><span class="fu">sfStop</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Results ----</span></span>
<span><span class="co"># 'result' is a list of lists.</span></span>
<span></span>
<span><span class="co"># Extract results dataframes by string and rbind them</span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">result</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"res"</span><span class="op">)</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">resdf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu">rbindlist</span><span class="op">(</span><span class="va">res</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># . Summary statistics by passage scenario -----</span></span>
<span><span class="co"># Summary data for plotting results by genetic reporting group region</span></span>
<span><span class="va">plotter</span> <span class="op">&lt;-</span> <span class="va">resdf</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">fM</span>, <span class="va">downstream</span>, <span class="va">downstream_j</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span></span>
<span>    fit <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">spawners</span><span class="op">)</span>,</span>
<span>    lwr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">spawners</span>, <span class="fl">0.025</span><span class="op">)</span>,</span>
<span>    upr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">spawners</span>, <span class="fl">0.975</span><span class="op">)</span>,</span>
<span>    iterations <span class="op">=</span> <span class="fu">n</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>downstream <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">downstream</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plotter</span></span>
<span></span>
<span><span class="co"># Plot of results</span></span>
<span><span class="va">ct_plot</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">plotter</span>, </span>
<span>                  <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">downstream_j</span>,</span>
<span>                      y <span class="op">=</span> <span class="va">fit</span>,</span>
<span>                      color <span class="op">=</span> <span class="va">downstream</span>,</span>
<span>                      fill <span class="op">=</span> <span class="va">downstream</span></span>
<span>                      <span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_ribbon</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span></span>
<span>    xmax <span class="op">=</span> <span class="va">downstream_j</span>, ymin <span class="op">=</span> <span class="va">lwr</span>, ymax <span class="op">=</span> <span class="va">upr</span>,</span>
<span>    color <span class="op">=</span> <span class="cn">NULL</span></span>
<span>  <span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">guides</span><span class="op">(</span>fill <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>nrow <span class="op">=</span> <span class="fl">1</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_hline</span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">1.3e6</span>, linetype <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1e7</span>, <span class="fl">.5e6</span><span class="op">)</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span>, <span class="fl">.5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">xlab</span><span class="op">(</span><span class="st">"Downstream juvenile survival"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ylab</span><span class="op">(</span><span class="st">"Number of Spawners (millions of fish)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span></span>
<span>    panel.spacing.x <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">.01</span>, units <span class="op">=</span> <span class="st">"npc"</span><span class="op">)</span>,</span>
<span>    panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    legend.position <span class="op">=</span> <span class="st">"top"</span>,</span>
<span>    legend.box <span class="op">=</span> <span class="st">"horizontal"</span>,</span>
<span>    legend.margin <span class="op">=</span> <span class="fu">margin</span><span class="op">(</span><span class="fu">unit</span><span class="op">(</span><span class="fl">.5</span>, units <span class="op">=</span> <span class="st">"npc"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    axis.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"black"</span>, size <span class="op">=</span> <span class="fl">8</span><span class="op">)</span>,</span>
<span>    axis.title.x <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>vjust <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>    axis.title.y <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>vjust <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,</span>
<span>    strip.background <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    strip.text.x <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">ct_plot</span></span></code></pre></div>
<figure><img src="reference/figures/ct_shad.jpg?raw=true" alt="Example simulation for historical fish passage scenarios in the Connecticut River. The horizontal dashed line indicates the maximum estimated abundance in the river prior to 1974"><figcaption><b>Figure 3</b>: Example simulation for historical fish passage scenarios in the Connecticut River. The horizontal dashed line indicates the maximum estimated abundance in the river prior to 1974.
</figcaption></figure><p> </p>
</div>
<div class="section level3">
<h3 id="running-multiple-scenarios-for-many-rivers-many-times-in-parallel">Running multiple scenarios for many rivers many times in parallel<a class="anchor" aria-label="anchor" href="#running-multiple-scenarios-for-many-rivers-many-times-in-parallel"></a>
</h3>
<p>This example uses the randomized sampling scenarios used in ASMFC (2024) for range-wide blueback herring population assessment. It randomly samples rivers from all available populations, and selects a management scenario (“no dams”, “no passage”, “current”) randomly for broad-scale simulation. Note that this scenario would need to be run &gt; 1 million times to produce stabilized results for all populations included.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Package load ----</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">snowfall</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://danstich.github.io/anadrofish/">anadrofish</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set a seed for random number generators for reproducibility ----</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">12345</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Parallel settings ----</span></span>
<span><span class="co"># Get number of cores for simulation using parallel package</span></span>
<span><span class="va">ncpus</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html" class="external-link">detectCores</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span></span>
<span></span>
<span><span class="co"># Initialize snowfall socket cluster</span></span>
<span><span class="fu">sfInit</span><span class="op">(</span>parallel <span class="op">=</span> <span class="cn">TRUE</span>, cpus <span class="op">=</span> <span class="va">ncpus</span>, type <span class="op">=</span> <span class="st">"SOCK"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Wrapper function ----</span></span>
<span><span class="va">sim</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Define passage scenarios used for ASFMC (2024)</span></span>
<span>  <span class="va">passages</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>, <span class="co"># No passage</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>, <span class="co"># No dams</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.31</span>, <span class="fl">0.8</span>, <span class="fl">0.90</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="co"># Current</span></span>
<span></span>
<span>  <span class="va">scenarios</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"No passage"</span>, <span class="st">"No dams"</span>, <span class="st">"Current"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Randomly sample the scenario for each iteration</span></span>
<span>  <span class="va">scenario_num</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">1</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">scenario</span> <span class="op">&lt;-</span> <span class="va">scenarios</span><span class="op">[</span><span class="va">scenario_num</span><span class="op">]</span></span>
<span>  <span class="va">passage</span> <span class="op">&lt;-</span> <span class="va">passages</span><span class="op">[[</span><span class="va">scenario_num</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span>  <span class="co"># Choose a species</span></span>
<span>  <span class="va">species</span> <span class="op">&lt;-</span> <span class="st">"BBH"</span></span>
<span></span>
<span>  <span class="co"># . Call simulation ----</span></span>
<span>  <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/sim_pop.html">sim_pop</a></span><span class="op">(</span></span>
<span>    species <span class="op">=</span> <span class="va">species</span>,</span>
<span>    river <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="reference/get_rivers.html">get_rivers</a></span><span class="op">(</span><span class="va">species</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="reference/get_rivers.html">get_rivers</a></span><span class="op">(</span><span class="va">species</span><span class="op">)</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span><span class="op">]</span></span>
<span>    <span class="op">)</span>,</span>
<span>    nyears <span class="op">=</span> <span class="fl">50</span>,</span>
<span>    n_init <span class="op">=</span> <span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/rnegbin.html" class="external-link">rnegbin</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1e6</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>    sr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html" class="external-link">rbeta</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">100</span>, <span class="fl">100</span><span class="op">)</span>,</span>
<span>    b <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>    upstream <span class="op">=</span> <span class="va">passage</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>    downstream <span class="op">=</span> <span class="va">passage</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,</span>
<span>    downstream_j <span class="op">=</span> <span class="va">passage</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>,</span>
<span>    output_years <span class="op">=</span> <span class="st">"last"</span>,</span>
<span>    age_structured_output <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    sex_specific <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># . Define the output lists ----</span></span>
<span>  <span class="va">res</span><span class="op">$</span><span class="va">scenario</span> <span class="op">&lt;-</span> <span class="va">scenario</span></span>
<span></span>
<span>  <span class="va">retlist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    res <span class="op">=</span> <span class="va">res</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">retlist</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span></span>
<span><span class="co"># Parallel execution ----</span></span>
<span><span class="co"># . Load libraries on workers -----</span></span>
<span><span class="fu">sfLibrary</span><span class="op">(</span><span class="va">anadrofish</span><span class="op">)</span></span>
<span><span class="fu">sfLibrary</span><span class="op">(</span><span class="va">tidyverse</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># . Distribute to workers -----</span></span>
<span><span class="co"># Number of simulations to run</span></span>
<span><span class="co"># You will need to run this MANY more times (1 million+) to stabilize results</span></span>
<span><span class="va">niterations</span> <span class="op">&lt;-</span> <span class="fl">1e2</span></span>
<span></span>
<span><span class="co"># Run the simulation ----</span></span>
<span><span class="co"># Assign starting time</span></span>
<span><span class="va">start</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run the sim</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">sfLapply</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">niterations</span>, <span class="va">sim</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calculate and print run time</span></span>
<span><span class="va">total_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="va">start</span></span>
<span><span class="va">total_time</span></span>
<span></span>
<span><span class="co"># . Stop snowfall ----</span></span>
<span><span class="fu">sfStop</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Results ----</span></span>
<span><span class="co"># 'result' is a list of lists.</span></span>
<span></span>
<span><span class="co"># Extract results dataframes by string and rbind them</span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">result</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"res"</span><span class="op">)</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">resdf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu">rbindlist</span><span class="op">(</span><span class="va">res</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># . Summary statistics by passage scenario -----</span></span>
<span><span class="co"># Summary data for plotting results by genetic reporting group region</span></span>
<span><span class="va">plotter</span> <span class="op">&lt;-</span> <span class="va">resdf</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">region</span>, <span class="va">river</span>, <span class="va">scenario</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span></span>
<span>    pop <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">spawners</span><span class="op">)</span>,</span>
<span>    lci <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">spawners</span>, <span class="fl">0.025</span><span class="op">)</span>,</span>
<span>    uci <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">spawners</span>, <span class="fl">0.975</span><span class="op">)</span>,</span>
<span>    samp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">spawners</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">plotter</span> <span class="op">&lt;-</span> <span class="va">plotter</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">scenario</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span></span>
<span>    pop <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">pop</span><span class="op">)</span>,</span>
<span>    lwr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">lci</span><span class="op">)</span>,</span>
<span>    upr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">uci</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Names for fish passage scenarios</span></span>
<span><span class="va">n_pass</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">plotter</span><span class="op">$</span><span class="va">pop</span><span class="op">[</span><span class="va">plotter</span><span class="op">$</span><span class="va">scenario</span> <span class="op">==</span> <span class="st">"No passage"</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">plotter</span><span class="op">$</span><span class="va">scenario</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">plotter</span><span class="op">$</span><span class="va">scenario</span>,</span>
<span>  levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"No passage"</span>, <span class="st">"Current"</span>, <span class="st">"No dams"</span><span class="op">)</span>,</span>
<span>  labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"No passage"</span>, <span class="st">"Current"</span>, <span class="st">"No dams"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot of results</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">plotter</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">scenario</span>, y <span class="op">=</span> <span class="va">pop</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_linerange</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xmax <span class="op">=</span> <span class="va">scenario</span>, ymin <span class="op">=</span> <span class="va">lwr</span>, ymax <span class="op">=</span> <span class="va">upr</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_hline</span><span class="op">(</span>yintercept <span class="op">=</span> <span class="va">n_pass</span>, linetype <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">guides</span><span class="op">(</span>fill <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>nrow <span class="op">=</span> <span class="fl">1</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1e9</span>, <span class="fl">1e7</span><span class="op">)</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1000</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">xlab</span><span class="op">(</span><span class="st">"Scenario"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ylab</span><span class="op">(</span><span class="st">"Coastwide blueback herring abundance (millions of fish)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span></span>
<span>    legend.position <span class="op">=</span> <span class="st">"top"</span>,</span>
<span>    legend.box <span class="op">=</span> <span class="st">"horizontal"</span>,</span>
<span>    legend.margin <span class="op">=</span> <span class="fu">margin</span><span class="op">(</span><span class="fu">unit</span><span class="op">(</span><span class="fl">.5</span>, units <span class="op">=</span> <span class="st">"npc"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<figure><img src="reference/figures/coastal_bbh.jpg?raw=true" alt="Example result from coast-wide blueback herring simulation"><figcaption><b>Figure 4</b>: Example result from coast-wide blueback herring simulation.
</figcaption></figure><p> </p>
</div>
<div class="section level3">
<h3 id="creating-a-custom-population">Creating a custom population<a class="anchor" aria-label="anchor" href="#creating-a-custom-population"></a>
</h3>
<p>In this example, we create a custom population for alewife using the names from the <code><a href="reference/custom_habitat_template.html">custom_habitat_template()</a></code> to build a dataframe with a novel habitat configuration. This simple example also demonstrates use of dam-specific upstream passage efficiencies. It is important to note that in more complex systems (e.g., with multiple upstream migration paths), dam-specific passage rates are not currently supported. For example, if we had a fourth dam with <code>dam_order</code> of <code>2</code> in our example below, it would not be explicitly upstream of either of the two dams with <code>dam_order</code> of <code>1</code>. We are currently working to implement matrix-based operations for custom habitat datasets that will allow for dam-specific fish passage rates in more complex systems. Until then, catchment-wide passage efficiencies can be applied in those complex systems, or the systems can be simplified using <code><a href="reference/custom_habitat_template.html">custom_habitat_template()</a></code> to address dam-specific questions.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Package load ----</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">snowfall</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://danstich.github.io/anadrofish/">anadrofish</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set a seed for random number generators for reproducibility ----</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">12345</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Parallel settings ----</span></span>
<span><span class="co"># Get number of cores for simulation using parallel package</span></span>
<span><span class="va">ncpus</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html" class="external-link">detectCores</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span></span>
<span></span>
<span><span class="co"># Initialize snowfall socket cluster</span></span>
<span><span class="fu">sfInit</span><span class="op">(</span>parallel <span class="op">=</span> <span class="cn">TRUE</span>, cpus <span class="op">=</span> <span class="va">ncpus</span>, type <span class="op">=</span> <span class="st">"SOCK"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Wrapper function ----</span></span>
<span><span class="va">sim</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Define a novel hydrosystem in the mid-Atlantic region</span></span>
<span>  <span class="co"># using `custom_habitat_template()` or by creating a template</span></span>
<span>  <span class="co"># using the same columns. You could export this in a .csv</span></span>
<span>  <span class="co"># for manual entry, use an external dataset with matching</span></span>
<span>  <span class="co"># variables (columns) as the template, or just use the names</span></span>
<span>  <span class="co"># of the columns to make your own dataframe in R</span></span>
<span>  <span class="va">novel_config</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/custom_habitat_template.html">custom_habitat_template</a></span><span class="op">(</span></span>
<span>    species <span class="op">=</span> <span class="st">"ALE"</span>,</span>
<span>    built_in <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    river <span class="op">=</span> <span class="st">"new_config"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Check out the names so we can build a simple,</span></span>
<span>  <span class="co"># in-line example for demonstration</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">novel_config</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Heavily commented novel habitat definition</span></span>
<span>  <span class="va">novel_config</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    <span class="co"># Can be anything</span></span>
<span>    river <span class="op">=</span> <span class="st">"new_config"</span>,</span>
<span>    <span class="co"># Must be from pre-defined within species (biological basis for this)</span></span>
<span>    region <span class="op">=</span> <span class="st">"MAT"</span>,</span>
<span>    <span class="co"># Can be anything, not actually used in biological models</span></span>
<span>    govt <span class="op">=</span> <span class="st">"NY"</span>,</span>
<span>    <span class="co"># Used for latitudinal trends in life-history traits for American shad only</span></span>
<span>    lat <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>    <span class="co"># Not actually used in the models, but could be useful for data querying</span></span>
<span>    <span class="co"># in the future</span></span>
<span>    lon <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>    <span class="co"># Number of dams from each element back to first. This example has two</span></span>
<span>    <span class="co"># dams that are each the first dam within their "migration route". That</span></span>
<span>    <span class="co"># means at least one of the dams is on a tributary in this configuration.</span></span>
<span>    dam_order <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>    <span class="co"># Amount of habitat (surface area in square km)</span></span>
<span>    <span class="va">Hab_sqkm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Choose a species</span></span>
<span>  <span class="va">species</span> <span class="op">&lt;-</span> <span class="st">"ALE"</span></span>
<span></span>
<span>  <span class="co"># . Call simulation ----</span></span>
<span>  <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/sim_pop.html">sim_pop</a></span><span class="op">(</span></span>
<span>    species <span class="op">=</span> <span class="va">species</span>,</span>
<span>    river <span class="op">=</span> <span class="st">"new_config"</span>,</span>
<span>    nyears <span class="op">=</span> <span class="fl">50</span>,</span>
<span>    n_init <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1e4</span>, <span class="fl">2e6</span><span class="op">)</span>,</span>
<span>    sr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html" class="external-link">rbeta</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">100</span>, <span class="fl">100</span><span class="op">)</span>,</span>
<span>    b <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>    upstream <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0.5</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>    downstream <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    downstream_j <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    custom_habitat <span class="op">=</span> <span class="va">novel_config</span>,</span>
<span>    output_years <span class="op">=</span> <span class="st">"last"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># . Define the output lists ----</span></span>
<span></span>
<span>  <span class="va">retlist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    res <span class="op">=</span> <span class="va">res</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">retlist</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span></span>
<span><span class="co"># Parallel execution ----</span></span>
<span><span class="co"># . Load libraries on workers -----</span></span>
<span><span class="fu">sfLibrary</span><span class="op">(</span><span class="va">anadrofish</span><span class="op">)</span></span>
<span><span class="fu">sfLibrary</span><span class="op">(</span><span class="va">tidyverse</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># . Distribute to workers -----</span></span>
<span><span class="co"># Number of simulations to run</span></span>
<span><span class="co"># You will need to run this MANY more times (1 million+) to stabilize results</span></span>
<span><span class="va">niterations</span> <span class="op">&lt;-</span> <span class="fl">1e2</span></span>
<span></span>
<span><span class="co"># Run the simulation ----</span></span>
<span><span class="co"># Assign starting time</span></span>
<span><span class="va">start</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run the sim</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">sfLapply</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">niterations</span>, <span class="va">sim</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calculate and print run time</span></span>
<span><span class="va">total_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="va">start</span></span>
<span><span class="va">total_time</span></span>
<span></span>
<span><span class="co"># . Stop snowfall ----</span></span>
<span><span class="fu">sfStop</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Results ----</span></span>
<span><span class="co"># 'result' is a list of lists.</span></span>
<span></span>
<span><span class="co"># Extract results dataframes by string and rbind them</span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">result</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"res"</span><span class="op">)</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">resdf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu">rbindlist</span><span class="op">(</span><span class="va">res</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># . Quick summary statistics ----</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">resdf</span><span class="op">$</span><span class="va">spawners</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># . Plot ----</span></span>
<span><span class="va">custom_plot</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">resdf</span>, <span class="fu">aes</span><span class="op">(</span><span class="va">spawners</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_histogram</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">xlab</span><span class="op">(</span><span class="st">"Spawning adults"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ylab</span><span class="op">(</span><span class="st">"Count"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">custom_plot</span></span></code></pre></div>
<figure><img src="reference/figures/custom_ale.jpg?raw=true" alt="Simulation result for custom alewife river (novel system)"><figcaption><b>Figure 5</b>: Simulation result for custom alewife river (novel system).
</figcaption></figure><p> </p>
</div>
<div class="section level3">
<h3 id="benchmarking-against-related-r-package">Benchmarking against related R package<a class="anchor" aria-label="anchor" href="#benchmarking-against-related-r-package"></a>
</h3>
<p>This example provides a brief benchmarking demonstration against a similar, more complex (individual-based) shad and river herring models from the <a href="https://github.com/danStich/shadia" class="external-link"><code>shadia</code></a> R package.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Libraries ----</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">shadia</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://danstich.github.io/anadrofish/">anadrofish</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/joshuaulrich/microbenchmark/" class="external-link">microbenchmark</a></span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Set seed for rng ----</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">12345</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Benchmarking ----</span></span>
<span><span class="co"># Notes:</span></span>
<span><span class="co"># Uses default settings for upstream passage and downstream survival</span></span>
<span><span class="co"># rates of `1` at all dams, otherwise used same settings across modeling</span></span>
<span><span class="co"># frameworks to standardize as much as possible.</span></span>
<span></span>
<span><span class="co"># The warnings() output is coming from the C++ function that moves individual</span></span>
<span><span class="co"># fish upstream through rivers in shadia::penobscotRiverModel(). This does not</span></span>
<span><span class="co"># appear to be influencing accuracy of estimates compared to published research,</span></span>
<span><span class="co"># but may result in deserialization of nodes in parallel processing, so we use</span></span>
<span><span class="co"># a serial approach to benchmarking below. We have not suppressed those warnings </span></span>
<span><span class="co"># here for the sake of transparency (`shadia` models were even slower before </span></span>
<span><span class="co"># any updates that could have caused this warning).</span></span>
<span></span>
<span><span class="co"># We use `microbenchmark::microbenchmark()` because run time for 1 iteration</span></span>
<span><span class="co"># of `anadrofish` package models is &lt;&lt; 1 second compared to ~ 30 second for</span></span>
<span><span class="co"># `shadia` package models.</span></span>
<span></span>
<span><span class="co"># The total number of `times` in in `microbenchmark()` would normally be higher,</span></span>
<span><span class="co"># but the individual-based models in `shadia` take a long time to run in serial</span></span>
<span><span class="co"># and the difference in run times is several orders of magnitude here.</span></span>
<span><span class="va">mb_test</span> <span class="op">&lt;-</span> <span class="fu">microbenchmark</span><span class="op">(</span></span>
<span>  <span class="st">"shadia_check"</span> <span class="op">=</span> <span class="op">{</span></span>
<span>    <span class="va">test</span> <span class="op">&lt;-</span> <span class="fu">penobscotRiverModel</span><span class="op">(</span></span>
<span>      nRuns <span class="op">=</span> <span class="fl">1</span>,</span>
<span>      species <span class="op">=</span> <span class="st">"shad"</span>,</span>
<span>      nYears <span class="op">=</span> <span class="fl">30</span>,</span>
<span>      n_adults <span class="op">=</span> <span class="fl">10000</span>,</span>
<span>      watershed <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>      output_years <span class="op">=</span> <span class="st">"last"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  <span class="st">"anadrofish_test"</span> <span class="op">=</span> <span class="op">{</span></span>
<span>    <span class="va">test</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/sim_pop.html">sim_pop</a></span><span class="op">(</span></span>
<span>      species <span class="op">=</span> <span class="st">"AMS"</span>,</span>
<span>      nyears <span class="op">=</span> <span class="fl">30</span>,</span>
<span>      n_init <span class="op">=</span> <span class="fl">10000</span>,</span>
<span>      river <span class="op">=</span> <span class="st">"Penobscot"</span>,</span>
<span>      output_years <span class="op">=</span> <span class="st">"last"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  times <span class="op">=</span> <span class="fl">10</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Our results (<code>mb_test</code>) should look something like this:</p>
<table style="width:100%;" class="table">
<colgroup>
<col width="20%">
<col width="10%">
<col width="10%">
<col width="10%">
<col width="10%">
<col width="10%">
<col width="10%">
<col width="10%">
<col width="10%">
</colgroup>
<thead><tr class="header">
<th align="left">expr</th>
<th align="right">min</th>
<th align="right">lq</th>
<th align="right">mean</th>
<th align="right">median</th>
<th align="right">uq</th>
<th align="right">max</th>
<th align="right">neval</th>
<th align="right">cld</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">shadia_check (ms)</td>
<td align="right">32428.537</td>
<td align="right">34306.0663</td>
<td align="right">38115.6585</td>
<td align="right">37837.9312</td>
<td align="right">42599.1752</td>
<td align="right">45740.3324</td>
<td align="right">10</td>
<td align="right">a</td>
</tr>
<tr class="even">
<td align="left">anadrofish_test (ms)</td>
<td align="right">55.809</td>
<td align="right">111.2171</td>
<td align="right">116.7442</td>
<td align="right">118.4982</td>
<td align="right">133.6141</td>
<td align="right">143.2512</td>
<td align="right">10</td>
<td align="right">b</td>
</tr>
</tbody>
</table>
<p> </p>
</div>
</div>
<div class="section level2">
<h2 id="directories">Directories<a class="anchor" aria-label="anchor" href="#directories"></a>
</h2>
<p><code>data/</code> Built-in data sets for the package</p>
<p><code>inst/examples/</code> Examples for those requiring more than a one-liner</p>
<p><code>inst/data/</code> Example dataset for <code>README.md</code>. Included in <code>.Rbuildignore</code>.</p>
<p><code>man/</code> Help files and documentation, example figures for readme</p>
<p><code>R/</code> R functions in scripts</p>
<p><code>tests/</code> Function tests and checks using the <code>testhat</code> package</p>
<p> </p>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<p>ASMFC (Atlantic States Marine Fisheries Commission). 2020. American Shad Benchmark Stock Assessment and Peer-Review Report. Atlantic States Marine Fisheries Commission. <a href="https://asmfc.org/wp-content/uploads/2025/01/AmShadBenchmarkStockAssessment_PeerReviewReport_2020_web.pdf" class="external-link">https://asmfc.org/wp-content/uploads/2025/01/AmShadBenchmarkStockAssessment_PeerReviewReport_2020_web.pdf</a>.</p>
<p>ASMFC (Atlantic States Marine Fisheries Commission). 2024. River Herring Benchmark Stock Assessment and Peer-Review Report. Atlantic States Marine Fisheries Commission. <a href="https://asmfc.org/wp-content/uploads/2025/01/RiverHerringAssessment_PeerReviewReport_2024.pdf" class="external-link">https://asmfc.org/wp-content/uploads/2025/01/RiverHerringAssessment_PeerReviewReport_2024.pdf</a>.</p>
<p>Bell, C. E., and B. Kynard. 1985. Mortality of Adult American Shad Passing Through a 17-Megawatt Kaplan Turbine at a Low-Head Hydroelectric Dam. North American Journal of Fisheries Management 5:33-38.<a href="https://doi.org/10.1577/1548-8659(1985)5%3C33:MOAASP%3E2.0.CO;2" class="external-link">10.1577/1548-8659(1985)5&lt;33:MOAASP&gt;2.0.CO;2</a></p>
<p>Csardi G., J. Hester J, H. Wickham, W. Chang, M. Morgan, and D. Tenenbaum. 2024. remotes: R Package Installation from Remote Repositories, Including ‘GitHub’. R package version 2.5.0, <a href="https://CRAN.R-project.org/package=remotes" class="external-link">https://CRAN.R-project.org/package=remotes</a>.</p>
<p>Wickham H., J. Hester, W. Chang, and J. Bryan. 2022. devtools: Tools to Make Developing R Packages Easier.R package version 2.4.5. <a href="https://CRAN.R-project.org/package=devtools" class="external-link">https://CRAN.R-project.org/package=devtools</a>.</p>
<p>Wipplehauser, G. 2021. Recovery of Diadromous Fishes: A Kennebec River Case Study. Transactions of the American Fisheries Society 150:277-290. <a href="https://onlinelibrary.wiley.com/doi/full/10.1002/tafs.10292" class="external-link">https://onlinelibrary.wiley.com/doi/full/10.1002/tafs.10292</a></p>
<p>Zydlewski, J., D. S. Stich, S. Roy, M. Bailey, T. Sheehan, and K. Sprankle. 2021. What Have We Lost? Modeling Dam Impacts on American Shad Populations Through Their Native Range. Frontiers in Marine Science 8. <a href="https://doi.org/10.3389/fmars.2021.734213" class="external-link">https://doi.org/10.3389/fmars.2021.734213</a>.</p>
</div>
</div>
  </main><aside class="col-md-3"><div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li>GPL (&gt;= 3)</li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing anadrofish</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Daniel S. Stich <br><small class="roles"> Author, maintainer </small> <a href="https://orcid.org/0000-0002-8946-1115" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a>  </li>
<li>J. D. Hardesty <br><small class="roles"> Author </small> <a href="https://orcid.org/0009-0009-0280-1999" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a>  </li>
<li>N. T. Jordan <br><small class="roles"> Author </small> <a href="https://orcid.org/0009-0009-8632-6979" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a>  </li>
<li>S. G. Roy <br><small class="roles"> Author </small> <a href="https://orcid.org/0000-0002-2491-948X" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a>  </li>
<li>T. F. Sheehan <br><small class="roles"> Author </small> <a href="https://orcid.org/0000-0002-9689-1180" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a>  </li>
<li>S. D. Snyder <br><small class="roles"> Author </small> <a href="https://orcid.org/0000-0003-3286-4957" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a>  </li>
<li>J. D. Zydlewski <br><small class="roles"> Author </small> <a href="https://orcid.org/0000-0002-2255-2303" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a>  </li>
</ul>
</div>



  </aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Daniel S. Stich, J. D. Hardesty, N. T. Jordan, S. G. Roy, T. F. Sheehan, S. D. Snyder, J. D. Zydlewski.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
